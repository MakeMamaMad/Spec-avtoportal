name: autoposter-youtube

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'  # 09:00 UTC = 12:00 МСК (Вт/Чт/Сб)

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ffmpeg
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install deps
        shell: bash
        run: |
          cd tools/autoposter
          pip install -r requirements.txt

      - name: Restore YouTube secrets
        shell: bash
        env:
          YT_CLIENT_B64: ${{ secrets.YOUTUBE_CLIENT_SECRETS_B64 }}
          YT_TOKEN_B64: ${{ secrets.YOUTUBE_TOKEN_B64 }}
        run: |
          cd tools/autoposter
          echo "$YT_CLIENT_B64" | base64 -d > client_secrets.json
          echo "$YT_TOKEN_B64" | base64 -d > youtube_token.json

      - name: Debug list and preview news.json
        shell: bash
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la "$GITHUB_WORKSPACE/frontend" || true
          ls -la "$GITHUB_WORKSPACE/frontend/data" || true
          echo "---- head ----"
          head -c 2000 "$GITHUB_WORKSPACE/frontend/data/news.json" || true

      - name: Run autoposter (digest Top-3)
        shell: bash
        env:
          SITE_URL: "https://spec-avtoportal.ru/"
          TELEGRAM_URL: "https://t.me/specavtoportal"
          CONTENT_JSON_PATH: "$GITHUB_WORKSPACE/frontend/data/news.json"

          LOGO_PATH: "$GITHUB_WORKSPACE/frontend/spec_avtoportal_favicon.ico"

          TOTAL_SECONDS: "30"
          INTRO_SECONDS: "1.5"
          OUTRO_SECONDS: "2.5"
          PICK_TARGET: "4"
          SUMMARY_MAX: "120"

          VOICE: "ru-RU-DmitryNeural"
          TTS_RATE: "-10%"
    
          YOUTUBE_CLIENT_SECRETS: "client_secrets.json"
          YOUTUBE_TOKEN_FILE: "youtube_token.json"
          YOUTUBE_PRIVACY: "public"

          VIDEO_WIDTH: "1080"
          VIDEO_HEIGHT: "1920"
          FPS: "30"

        run: |
          cd tools/autoposter
          export CONTENT_JSON_PATH="$GITHUB_WORKSPACE/frontend/data/news.json"
          python -m src.main

      - name: Commit state (posted.json)
        shell: bash
        run: |
          git config user.name "specavto-autoposter"
          git config user.email "actions@users.noreply.github.com"
          git add tools/autoposter/state/posted.json || true
          git commit -m "autoposter: update state" || echo "Nothing to commit"
          git push || true

      - name: Upload artifacts (video + caption for IG/TT)
        uses: actions/upload-artifact@v4
        with:
          name: autoposter-output
          path: tools/autoposter/out/*
          if-no-files-found: ignore
