name: Ingest & Publish

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (if any)
        shell: bash
        run: |
          set -eux
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "aggregator/requirements.txt" ]; then pip install -r aggregator/requirements.txt; fi
          pip install pyyaml >/dev/null 2>&1 || true

      - name: Quick YAML check (rss length)
        shell: bash
        run: |
          set -eux
          python - <<'PY'
          import yaml, pathlib
          p = pathlib.Path('aggregator/sources.yml')
          data = yaml.safe_load(p.read_text(encoding='utf-8'))
          rss = data.get('rss') or []
          print('rss items:', len(rss))
          if rss:
              print('first rss url:', rss[0].get('url'))
          PY

      # Запускаем ТВОЙ агрегатор, сразу с явными параметрами
      - name: Run aggregator
        shell: bash
        run: |
          set -euxo pipefail
          python aggregator/main.py --sources aggregator/sources.yml --output frontend/data/news.json || true
          # не падаем, даже если он вернул 1 — дальше сделаем фоллбек при пустом массиве

      # Fallback: если агрегатор отдал пусто или файл не создан — собрать feed из RSS KRONE
      - name: If empty → build feed from KRONE (fallback)
        shell: bash
        run: |
          set -eux
          python - <<'PY'
          import json, pathlib, urllib.request, urllib.parse, xml.etree.ElementTree as ET

          out = pathlib.Path("frontend/data/news.json")
          data = []
          if out.exists():
            try:
              data = json.loads(out.read_text(encoding="utf-8"))
            except Exception:
              data = []
          if data:
            print("Feed already has", len(data), "items — skip fallback")
            raise SystemExit(0)

          url = "https://www.krone-trailer.com/en/news/rss-feed"
          xml = urllib.request.urlopen(url, timeout=30).read()
          root = ET.fromstring(xml)

          def first(node, tag):
            el = node.find(tag)
            return (el.text or "").strip() if el is not None and el.text else ""

          items = []
          for it in root.findall(".//item")[:50]:
            title = first(it, "title")
            link  = first(it, "link")
            desc  = first(it, "description")
            pub   = first(it, "pubDate")
            img = ""
            enc = it.find("enclosure")
            if enc is not None and enc.get("url"):
              img = enc.get("url")
            import urllib.parse as UP
            dom = UP.urlparse(link).netloc
            items.append({
              "id": link or title,
              "title": title,
              "url": link,
              "domain": dom,
              "summary": desc,
              "image": img,
              "date": pub
            })

          out.parent.mkdir(parents=True, exist_ok=True)
          out.write_text(json.dumps(items, ensure_ascii=False), encoding="utf-8")
          print("Fallback wrote", len(items), "items")
          PY

      - name: Preview output
        shell: bash
        run: |
          set -eux
          wc -c frontend/data/news.json || true
          python - <<'PY'
          import json
          arr = json.load(open('frontend/data/news.json','rb'))
          print('items:', len(arr))
          for it in arr[:3]:
              print('-', (it.get('title') or '')[:120])
          PY

      - name: Commit & push changes
        shell: bash
        run: |
          set -eux
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: ingest feed → update frontend/data/news.json"
          git push
