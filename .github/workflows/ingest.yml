- name: Commit & push changes (with rebase & retries)
  env:
    BRANCH: main
  run: |
    set -euo pipefail

    git config user.name  "github-actions[bot]"
    git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

    if git diff --quiet; then
      echo "No changes to commit."
      exit 0
    fi

    git add -A
    git commit -m "chore: update data [skip ci]" || exit 0

    for i in 1 2 3; do
      echo "Attempt $i: fetch + rebase + push"
      git fetch origin "$BRANCH"
      if ! git rebase "origin/$BRANCH"; then
        git rebase --abort || true
        git pull --rebase origin "$BRANCH"
      fi
      if git push origin HEAD:"$BRANCH"; then
        echo "Pushed successfully."
        exit 0
      fi
      echo "Push failed, retrying in $((i*5))s..."
      sleep $((i*5))
    done

    echo "Push still failing, using --force-with-lease"
    git push --force-with-lease origin HEAD:"$BRANCH"
