name: Ingest & Publish

on:
  workflow_dispatch: {}
  # при желании можно включить расписание:
  # schedule:
  #   - cron: "*/30 5-20 * * *"   # каждые 30 минут с 08:00 до 23:59 МСК

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (if any)
        shell: bash
        run: |
          set -eux
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "aggregator/requirements.txt" ]; then pip install -r aggregator/requirements.txt; fi
          pip install pyyaml >/dev/null 2>&1 || true

      - name: Quick YAML check (rss length)
        shell: bash
        run: |
          set -eux
          python - <<'PY'
          import yaml, pathlib
          p = pathlib.Path('aggregator/sources.yml')
          data = yaml.safe_load(p.read_text(encoding='utf-8'))
          rss = data.get('rss') or []
          print('rss items:', len(rss))
          if rss:
              print('first rss url:', rss[0].get('url'))
          PY

      - name: Run aggregator
        shell: bash
        run: |
          set -euxo pipefail
          # если aggregator/main.py вернёт пусто — не падаем, дальше сработает fallback
          python aggregator/main.py --sources aggregator/sources.yml --output frontend/data/news.json || true

      # >>> ВОТ ТОТ САМЫЙ НОВЫЙ FALLBACK <<<
      - name: If empty → build feed from ALL RSS in sources.yml (fallback)
        shell: bash
        run: |
          set -eux
          python - <<'PY'
          import json, pathlib, urllib.request, urllib.parse, xml.etree.ElementTree as ET
          import yaml, time, hashlib

          OUT = pathlib.Path("frontend/data/news.json")
          SRC = pathlib.Path("aggregator/sources.yml")

          # если агрегатор уже создал непустой файл — выходим
          data = []
          if OUT.exists():
              try:
                  data = json.loads(OUT.read_text(encoding="utf-8"))
              except Exception:
                  data = []
          if data:
              print("Feed already has", len(data), "items — skip RSS fallback")
              raise SystemExit(0)

          cfg = yaml.safe_load(SRC.read_text(encoding="utf-8"))
          feeds = cfg.get("rss") or []
          if not feeds:
              print("No RSS in sources.yml — nothing to fallback")
              OUT.parent.mkdir(parents=True, exist_ok=True)
              OUT.write_text("[]", encoding="utf-8")
              raise SystemExit(0)

          items, seen = [], set()

          def add_item(title, link, summary, pub, img):
              key = link or title
              if not key:
                  key = hashlib.md5((title+summary).encode("utf-8","ignore")).hexdigest()
              if key in seen:
                  return
              seen.add(key)
              dom = urllib.parse.urlparse(link).netloc if link else ""
              items.append({
                  "id": key, "title": title or "", "url": link or "",
                  "domain": dom, "summary": summary or "", "image": img or "", "date": pub or ""
              })

          for f in feeds:
              url = (f.get("url") or "").strip()
              name = f.get("name") or url
              if not url:
                  continue
              try:
                  xml = urllib.request.urlopen(url, timeout=30).read()
                  root = ET.fromstring(xml)
                  cnt = 0
                  for it in root.findall(".//item"):
                      title = (it.findtext("title") or "").strip()
                      link  = (it.findtext("link")  or "").strip()
                      desc  = (it.findtext("description") or "").strip()
                      pub   = (it.findtext("pubDate") or "").strip()
                      img = ""
                      enc = it.find("enclosure")
                      if enc is not None and enc.get("url"):
                          img = enc.get("url")
                      add_item(title, link, desc, pub, img)
                      cnt += 1
                  print(f"[RSS] {name}: {cnt}")
              except Exception as e:
                  print(f"[RSS] {name}: ERROR {e}")

          def ts(x):
              s = x.get("date") or ""
              try:
                  return time.mktime(time.strptime(s[:25], "%a, %d %b %Y %H:%M:%S"))
              except Exception:
                  return 0

          items.sort(key=ts, reverse=True)

          OUT.parent.mkdir(parents=True, exist_ok=True)
          OUT.write_text(json.dumps(items, ensure_ascii=False), encoding="utf-8")
          print("Fallback wrote", len(items), "items from", len(feeds), "feeds")
          PY

      - name: Preview output
        shell: bash
        run: |
          set -eux
          wc -c frontend/data/news.json || true
          python - <<'PY'
          import json
          arr=json.load(open('frontend/data/news.json','rb'))
          print('items:', len(arr))
          for it in arr[:3]:
              print('-', (it.get('title') or '')[:120])
          PY

      - name: Commit & push changes
        shell: bash
        run: |
          set -eux
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: ingest feed → update frontend/data/news.json"
          git push
