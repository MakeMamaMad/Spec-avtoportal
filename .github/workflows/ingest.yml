- name: If empty → build feed from ALL RSS in sources.yml (fallback)
  shell: bash
  run: |
    set -eux
    python - <<'PY'
    import json, pathlib, urllib.request, urllib.parse, xml.etree.ElementTree as ET
    import yaml, time, hashlib

    OUT = pathlib.Path("frontend/data/news.json")
    SRC = pathlib.Path("aggregator/sources.yml")

    # Если агрегатор уже создал непустой файл — ничего не делаем
    data = []
    if OUT.exists():
        try:
            data = json.loads(OUT.read_text(encoding="utf-8"))
        except Exception:
            data = []
    if data:
        print("Feed already has", len(data), "items — skip RSS fallback")
        raise SystemExit(0)

    cfg = yaml.safe_load(SRC.read_text(encoding="utf-8"))
    feeds = cfg.get("rss") or []
    if not feeds:
        print("No RSS in sources.yml — nothing to fallback")
        OUT.parent.mkdir(parents=True, exist_ok=True)
        OUT.write_text("[]", encoding="utf-8")
        raise SystemExit(0)

    items = []
    seen = set()

    def add_item(title, link, summary, pub, img):
        # дедуп по URL (или title)
        key = link or title
        if not key: 
            key = hashlib.md5((title+summary).encode("utf-8", "ignore")).hexdigest()
        if key in seen: 
            return
        seen.add(key)
        dom = urllib.parse.urlparse(link).netloc if link else ""
        items.append({
            "id": key,
            "title": title or "",
            "url": link or "",
            "domain": dom,
            "summary": summary or "",
            "image": img or "",
            "date": pub or ""
        })

    for f in feeds:
        url = (f.get("url") or "").strip()
        name = f.get("name") or url
        if not url:
            continue
        try:
            xml = urllib.request.urlopen(url, timeout=30).read()
            root = ET.fromstring(xml)
            cnt = 0
            for it in root.findall(".//item"):
                title = (it.findtext("title") or "").strip()
                link  = (it.findtext("link")  or "").strip()
                desc  = (it.findtext("description") or "").strip()
                pub   = (it.findtext("pubDate") or "").strip()
                img = ""
                enc = it.find("enclosure")
                if enc is not None and enc.get("url"):
                    img = enc.get("url")
                add_item(title, link, desc, pub, img)
                cnt += 1
            print(f"[RSS] {name}: {cnt}")
        except Exception as e:
            print(f"[RSS] {name}: ERROR {e}")

    # небольшой порядок: свежие вверх по pubDate/дате в тексте
    def ts(x):
        s = x.get("date") or ""
        # best-effort —распарсить RFC822; если не вышло — 0
        try:
            return time.mktime(time.strptime(s[:25], "%a, %d %b %Y %H:%M:%S"))
        except Exception:
            return 0

    items.sort(key=ts, reverse=True)

    OUT.parent.mkdir(parents=True, exist_ok=True)
    OUT.write_text(json.dumps(items, ensure_ascii=False), encoding="utf-8")
    print("Fallback wrote", len(items), "items from", len(feeds), "feeds")
    PY
