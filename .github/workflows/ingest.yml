name: Ingest & Publish

on:
  workflow_dispatch:
  schedule:
    # при желании поправишь расписание
    - cron: '0 */3 * * *'
  push:
    paths:
      - 'aggregator/**'
      - '.github/workflows/ingest.yml'

# важно для push из GitHub Actions (особенно для public репо)
permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps if present
        run: |
          python -m pip install --upgrade pip

          # основной requirements агрегатора
          if [ -f "aggregator/requirements.txt" ]; then
            pip install -r aggregator/requirements.txt
          fi

          # опционально: отдельные зависимости для перевода (если ты вынес их отдельно)
          if [ -f "tools/translate-requirements.txt" ]; then
            pip install -r tools/translate-requirements.txt
          fi
          if [ -f "aggregator/translate-requirements.txt" ]; then
            pip install -r aggregator/translate-requirements.txt
          fi

      - name: Quick YAML check (aggregator/sources.yml)
        run: |
          python - << 'PY'
          import sys, pathlib, yaml

          path = pathlib.Path("aggregator/sources.yml")
          data = yaml.safe_load(path.read_text(encoding="utf-8"))

          if not isinstance(data, dict):
              print("sources.yml must be a mapping with top-level key 'sources'", file=sys.stderr)
              sys.exit(1)

          sources = data.get("sources")
          if not isinstance(sources, list):
              print("sources.yml: 'sources' must be a list", file=sys.stderr)
              sys.exit(1)

          print(f"OK: {len(sources)} sources configured.")
          PY

      - name: Run aggregator
        run: |
          python aggregator/main.py \
            --sources aggregator/sources.yml \
            --output frontend/data/news.json

      - name: Translate title & summary for foreign sources only
        env:
          NEWS_PATH: frontend/data/news.json
        run: |
          if [ -f "aggregator/translate_news.py" ]; then
            python aggregator/translate_news.py
          else
            echo "No translate script found at aggregator/translate_news.py — skipping translation."
          fi

      - name: Preview output
        run: |
          ls -R
          ls -l frontend/data || true
          echo "===== head of news.json ====="
          head -c 4000 frontend/data/news.json || true
          echo
          echo "============================="

      - name: Post new items to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_MAX_POSTS: "50"      # сколько старых новостей за один прогон
        run: |
          python aggregator/post_to_telegram.py || echo "Telegram step failed, but continuing"

      - name: Commit & push changes
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: actions@users.noreply.github.com
        run: |
          git status

          # Добавляем ВСЕ json из frontend/data (news.json, news_meta.json и т.д.)
          git add frontend/data/*.json || true

          # Если после add нет изменений — просто выходим
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update data json (automated ingest + translation)"
          git push origin main
