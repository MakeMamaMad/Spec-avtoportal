name: Ingest & Publish

on:
  workflow_dispatch: {}          # кнопка "Run workflow" в Actions
  # при желании включи расписание (пример: каждые 30 минут 06–22 МСК)
  # schedule:
  #   - cron: "*/30 3-19 * * *"

permissions:
  contents: write                # нужен коммит news.json

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (если есть)
        run: |
          set -eux
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "aggregator/requirements.txt" ]; then pip install -r aggregator/requirements.txt; fi
          pip install pyyaml jq || true

      # Валидируем YAML — чтобы сборщик не падал "внутри"
      - name: Validate aggregator/sources.yml
        run: |
          set -eux
          if [ ! -f "aggregator/sources.yml" ]; then
            echo "ERROR: aggregator/sources.yml not found" >&2
            exit 1
          fi
          python - <<'PY'
          import yaml, pathlib, sys
          p = pathlib.Path('aggregator/sources.yml')
          try:
              data = yaml.safe_load(p.read_text(encoding='utf-8'))
              assert isinstance(data, dict), "top-level must be a mapping"
              print("YAML OK. Keys:", list(data.keys()))
          except Exception as e:
              print("YAML ERROR:", e)
              sys.exit(1)
          PY

      # Запускаем ИМЕННО aggregator/main.py
      - name: Run aggregator
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          set -euxo pipefail
          # если твой скрипт поддерживает параметры вывода — используй их:
          python aggregator/main.py --sources aggregator/sources.yml --output frontend/data/news.json
          python aggregator/main.py

          # перенос результата в нужный путь, если скрипт кладёт файл не туда
          if [ -f "frontend/data/news.json" ]; then
            echo "frontend/data/news.json already exists"
          elif [ -f "aggregator/out/news.json" ]; then
            mkdir -p frontend/data
            cp aggregator/out/news.json frontend/data/news.json
          elif [ -f "data/news.json" ]; then
            mkdir -p frontend/data
            cp data/news.json frontend/data/news.json
          elif [ -f "news.json" ]; then
            mkdir -p frontend/data
            cp news.json frontend/data/news.json
          fi

          test -f frontend/data/news.json || { echo "ERROR: frontend/data/news.json not found"; exit 1; }

      - name: Preview output
        run: |
          set -eux
          wc -c frontend/data/news.json || true
          if command -v jq >/dev/null; then
            jq -c '.[0:3]' frontend/data/news.json || true
          else
            head -c 800 frontend/data/news.json || true
          fi

      - name: Commit & push changes
        run: |
          set -eux
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: ingest feed → update frontend/data/news.json"
          git push
