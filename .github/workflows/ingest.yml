name: Ingest & Publish

on:
  workflow_dispatch:
  schedule:
    # при желании поменяешь расписание
    - cron: '0 * * * *'
  push:
    paths:
      - 'aggregator/**'
      - '.github/workflows/ingest.yml'

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps if present
        run: |
          if [ -f "aggregator/requirements.txt" ]; then
            python -m pip install --upgrade pip
            pip install -r aggregator/requirements.txt
          fi

      - name: Quick YAML check (aggregator/sources.yml)
        run: |
          python - << 'PY'
          import sys, pathlib, yaml

          path = pathlib.Path("aggregator/sources.yml")
          data = yaml.safe_load(path.read_text(encoding="utf-8"))

          if not isinstance(data, dict):
              print("sources.yml must be a mapping with top-level key 'sources'", file=sys.stderr)
              sys.exit(1)

          sources = data.get("sources")
          if not isinstance(sources, list):
              print("sources.yml: 'sources' must be a list", file=sys.stderr)
              sys.exit(1)

          print(f"OK: {len(sources)} sources configured.")
          PY

      - name: Run aggregator
        run: |
          python aggregator/main.py \
            --sources aggregator/sources.yml \
            --output frontend/data/news.json

      - name: Preview output
        run: |
          ls -R
          ls -l frontend/data || true
          echo "===== head of news.json ====="
          head -c 4000 frontend/data/news.json || true
          echo
          echo "============================="

      - name: Commit & push changes (with rebase & retries)
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: actions@users.noreply.github.com
        run: |
          git status
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          for attempt in 1 2 3; do
            echo "Attempt $attempt to rebase & push"
            git pull --rebase origin main || true
            if git rebase --continue 2>/dev/null; then
              echo "Rebase continued"
            fi

            git add frontend/data/news.json

            if git commit -m "Update news.json (automated ingest)"; then
              if git push origin main; then
                echo "Push succeeded"
                exit 0
              fi
            fi

            echo "Push failed, retrying..."
            sleep 5
          done

          echo "Failed to push after 3 attempts"
          exit 1
